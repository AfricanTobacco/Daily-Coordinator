<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2196F3">
    <meta name="description" content="Daily Coordinator - Offline-first task tracking for SADC">
    <title>Daily Coordinator</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: #2196F3;
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .status-bar {
            padding: 0.75rem 1rem;
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
        }

        .status-dot.offline {
            background: #F44336;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
        }

        .task-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .task-id {
            font-weight: 600;
            color: #2196F3;
        }

        .task-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .task-status.success {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .task-status.failed {
            background: #FFEBEE;
            color: #C62828;
        }

        .task-status.pending {
            background: #FFF3E0;
            color: #E65100;
        }

        .task-meta {
            font-size: 0.875rem;
            color: #666;
            margin-top: 0.5rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #999;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .sync-button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.875rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sync-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        @media (max-width: 640px) {
            .container {
                padding: 0.5rem;
            }

            .task-card {
                padding: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã Daily Coordinator</h1>
    </div>

    <div class="status-bar">
        <div class="status-indicator">
            <span class="status-dot" id="connectionDot"></span>
            <span id="connectionStatus">Connecting...</span>
        </div>
        <button class="sync-button" id="syncButton" disabled>
            <span>üîÑ</span>
            <span>Sync</span>
        </button>
    </div>

    <div class="container">
        <div id="taskList" class="loading">
            <p>Loading tasks...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration (replace with your config)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Enable offline persistence
        enableIndexedDbPersistence(db)
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.warn('Multiple tabs open, persistence can only be enabled in one tab at a time.');
                } else if (err.code == 'unimplemented') {
                    console.warn('Browser doesn\'t support offline persistence');
                }
            });

        const taskList = document.getElementById('taskList');
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionDot = document.getElementById('connectionDot');
        const syncButton = document.getElementById('syncButton');

        // Monitor online/offline status
        function updateConnectionStatus() {
            const isOnline = navigator.onLine;
            connectionStatus.textContent = isOnline ? 'Online' : 'Offline';
            connectionDot.className = isOnline ? 'status-dot' : 'status-dot offline';
            syncButton.disabled = !isOnline;
        }

        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);
        updateConnectionStatus();

        // Listen to Firestore tasks collection
        const tasksQuery = query(
            collection(db, 'tasks'),
            orderBy('created_at', 'desc'),
            limit(50)
        );

        onSnapshot(tasksQuery, (snapshot) => {
            if (snapshot.empty) {
                taskList.innerHTML = `
                    <div class="empty-state">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                            <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                        </svg>
                        <p>No tasks yet</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">Tasks will appear here when coordinator runs</p>
                    </div>
                `;
                return;
            }

            taskList.innerHTML = '';
            snapshot.forEach((doc) => {
                const task = doc.data();
                const card = document.createElement('div');
                card.className = 'task-card';
                
                const statusClass = task.status === 'success' ? 'success' : 
                                   task.status === 'failed' ? 'failed' : 'pending';
                
                const timestamp = task.timestamp ? new Date(task.timestamp).toLocaleString() : 'Unknown';
                
                card.innerHTML = `
                    <div class="task-header">
                        <span class="task-id">${task.coordinator_id}</span>
                        <span class="task-status ${statusClass}">${task.status}</span>
                    </div>
                    <div class="task-meta">
                        <div>üìä Tasks processed: ${task.tasks_processed}</div>
                        <div>üïí ${timestamp}</div>
                        ${task.errors && task.errors.length > 0 ? `<div style="color: #C62828; margin-top: 0.5rem;">‚ö†Ô∏è ${task.errors.length} error(s)</div>` : ''}
                    </div>
                `;
                
                taskList.appendChild(card);
            });
        }, (error) => {
            console.error('Error fetching tasks:', error);
            taskList.innerHTML = `
                <div class="empty-state">
                    <p style="color: #C62828;">‚ùå Error loading tasks</p>
                    <p style="font-size: 0.875rem; margin-top: 0.5rem;">${error.message}</p>
                </div>
            `;
        });

        // Manual sync button (forces Firestore sync)
        syncButton.addEventListener('click', async () => {
            syncButton.disabled = true;
            syncButton.innerHTML = '<span>‚è≥</span><span>Syncing...</span>';
            
            setTimeout(() => {
                syncButton.innerHTML = '<span>üîÑ</span><span>Sync</span>';
                syncButton.disabled = !navigator.onLine;
            }, 2000);
        });
    </script>

    <script>
        // Register service worker for offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }
    </script>
</body>
</html>
